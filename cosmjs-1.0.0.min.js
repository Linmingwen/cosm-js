// cosmjs
// version 1.0.0a
// (c) 2012 pete correia [contact@petecorreia.com]
// http://petecorreia.com/cosmjs/
// released under the MIT license
var cosm=function(){var a,b="http://api.cosm.com/v2/",c,d=function(a){var b=[];for(var c in a)b.push(c+"="+a[c]);return b.join("&")},e=function(a,b){for(var c in b){a[c]=b[c]}return a};request=function(b){var c=e({type:"get"},b);if(!c.url){return}c.type=c.type.toUpperCase();if(c.type=="PUT"||c.type=="POST"){if(!c.data||typeof c.data!=="object"){return}else{c.data=JSON.stringify(c.data)}}$.ajax({url:c.url,type:c.type,headers:{"X-ApiKey":a},data:c.data,dataType:"json",cache:false}).done(c.done).fail(c.fail).always(c.always)},ws={socket:false,callbacks:{}};ws.message=function(a,b,c){if(b.body&&ws.callbacks[b.resource]){ws.callbacks[b.resource](b.body)}};ws.connect=function(a){if(window.MozWebSocket){window.WebSocket=window.MozWebSocket}if(!ws.socket&&window.WebSocket){ws.socket=new WebSocket("ws://api.cosm.com:8080/");ws.socket.onerror=function(a){if(ws.error){ws.error(a,this)}ws.connect()};ws.socket.onclose=function(a){if(ws.close){ws.close(a,this)}ws.connect()};ws.socket.onopen=function(b){if(a){a(this)}if(ws.error){ws.open(b,this)}};ws.socket.onmessage=function(a){var b=a.data;response=JSON.parse(b);ws.message(a,response,this)}}};ws.subscribe=function(b,c){var d='{"headers":{"X-ApiKey":"'+a+'"}, "method":"subscribe", "resource":"'+b+'"}';if(!ws.callbacks[b]){ws.callbacks[b]=c;if(!ws.socket){ws.connect(function(a){a.send(d)})}else{ws.socket.send(d)}}};ws.unsubscribe=function(b){var c='{"headers":{"X-ApiKey":"'+a+'"}, "method":"unsubscribe", "resource":"'+b+'"}';if(ws.callbacks[b]&&ws.socket){ws.socket.send(c);delete ws.callbacks[b]}};$.ajaxSetup({cache:false});public={endpoint:b,setKey:function(b){a=b},request:function(a){request(a)},subscribe:function(a,b){ws.subscribe(a,b)},unsubscribe:function(a){ws.unsubscribe(a)},live:function(a,c){var d=function(b){if(b.current_value){$(a).each(function(){$(this).html(b.current_value).attr("data-cosmjs-resource",c)})}};request({url:b+c,always:d});ws.subscribe(c,d)},stop:function(a){ws.unsubscribe($(a).first().attr("data-cosmjs-resource"))},feed:{get:function(a,c){request({url:b+"feeds/"+a+".json",always:c})},update:function(a,c,d){request({type:"put",url:b+"feeds/"+a+".json",data:c,always:d})},"new":function(a,c){request({type:"post",url:b+"feeds",data:a,always:c})},"delete":function(a,c){request({type:"delete",url:b+"feeds/"+a,always:c})},history:function(a,c,e){request({url:b+"feeds/"+a+".json",data:d(c),always:e})},list:function(a,c){request({url:b+"feeds",data:d(a),always:c})},subscribe:function(a,b){if(a){ws.subscribe("/feeds/"+a,b)}},unsubscribe:function(a,b){if(a){ws.unsubscribe("/feeds/"+a)}}},datastream:{get:function(a,c,d){request({url:b+"feeds/"+a+"/datastreams/"+c+".json",always:d})},update:function(a,c,d,e){request({type:"put",url:b+"feeds/"+a+"/datastreams/"+c+".json",data:d,always:e})},"new":function(a,c,d){request({type:"post",url:b+"feeds/"+a+"/datastreams",data:c,always:d})},"delete":function(a,c,d){request({type:"delete",url:b+"feeds/"+a+"/datastreams/"+c,always:d})},history:function(a,c,e,f){request({url:b+"feeds/"+a+"/datastreams/"+c+".json",data:d(e),always:f})},list:function(a,c){request({url:b+"feeds/"+a+".json",always:function(a){c.call(this,a.datastreams)}})},subscribe:function(a,b,c){if(a&&b){ws.subscribe("/feeds/"+a+"/datastreams/"+b,c)}},unsubscribe:function(a,b,c){if(a&&b){ws.unsubscribe("/feeds/"+a+"/datastreams/"+b)}},live:function(a,b,c){if(a&&b&&c){public.live(a,"/feeds/"+b+"/datastreams/"+c)}},stop:function(a){if(a){public.stop(a)}}},datapoint:{get:function(a,c,d,e){request({url:b+"feeds/"+a+"/datastreams/"+c+"/datapoints/"+d,always:e})},update:function(a,c,d,e,f){request({type:"put",url:b+"feeds/"+a+"/datastreams/"+c+"/datapoints/"+d,data:{value:e},always:f})},"new":function(a,c,d,e){request({type:"post",url:b+"feeds/"+a+"/datastreams/"+c+"/datapoints",data:d,always:e})},"delete":function(a,c,e,f){var g={type:"delete",always:f};if(typeof e==="object"){g.url=b+"feeds/"+a+"/datastreams/"+c+"/datapoints";g.data=d(e)}else{g.url=b+"feeds/"+a+"/datastreams/"+c+"/datapoints/"+e}request(g)},history:function(a,c,e,f){request({url:b+"feeds/"+a+"/datastreams/"+c+".json",data:d(e),always:function(a){f.call(this,a.datapoints)}})}}};return public}();(function(a){var b=function(a){if(typeof a==="object"){return"/feeds/"+a.feed+(a.datastream?"/datastreams/"+a.datastream:"")}else if(typeof a==="string"&&a!=""){return a}else{return""}},c={live:function(a){cosm.live(this,b(a));return this},get:function(c){var d=a(this);cosm.request({url:cosm.endpoint+b(c)+".json",always:function(b){d.each(function(){a(this).html(b.current_value)})}});return this}};a.fn.cosm=function(b){if(c[b]){return c[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return c.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.tooltip")}}})(jQuery);