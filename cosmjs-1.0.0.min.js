// cosmJS
// version 1.0.0a
// (c) 2012 pete correia [contact@petecorreia.com]
// http://petecorreia.com/cosmjs/
// released under the MIT license
var cosm=function(a){"use strict";var b="QiKJDoIHZt-7sxtavM1jRhS39B-SAKxFWHZIM0ZMSUV2ND0g",c="http://api.cosm.com/v2/",d,e=function(a){var b=[];for(var c in a){if(a.hasOwnProperty(c)){b.push(c+"="+a[c])}}return b.join("&")},f=function(a,b){for(var c in b){if(b.hasOwnProperty(c)){a[c]=b[c]}}return a},g=function(a){if(typeof a==="function"){a.apply(this,Array.prototype.slice.call(arguments,1))}else if(Object.prototype.toString.apply(a)==="[object Array]"){var b=a.length;while(b--){a[b].apply(this,Array.prototype.slice.call(arguments,1))}}},h=function(c){var d=f({type:"get"},c);if(!d.url){return}d.type=d.type.toUpperCase();if(d.type==="PUT"||d.type==="POST"){if(!d.data||typeof d.data!=="object"){return}else{d.data=JSON.stringify(d.data)}}a.ajax({url:d.url,type:d.type,headers:{"X-ApiKey":b},data:d.data,dataType:"json",cache:false}).done(d.done).fail(d.fail).always(d.always)},i={socket:false,socketReady:false,queue:[],resources:[]};i.connect=function(b){if(window.MozWebSocket){window.WebSocket=window.MozWebSocket}if(!i.socket&&window.WebSocket){i.socket=new WebSocket("ws://api.cosm.com:8080/");i.socket.onerror=function(a){if(i.error){i.error(a,this)}i.connect()};i.socket.onclose=function(a){if(i.close){i.close(a,this)}i.connect()};i.socket.onopen=function(a){i.socketReady=true;if(i.error){i.open(a,this)}if(i.queue.length){g(i.queue)}if(b){b(this)}};i.socket.onmessage=function(b){var c=b.data,d=JSON.parse(c);if(d.body){a("body").trigger("cosm."+d.resource,d.body)}}}};i.subscribe=function(c,d){var e='{"headers":{"X-ApiKey":"'+b+'"}, "method":"subscribe", "resource":"'+c+'"}';if(!i.resources[c]){i.resources.push(c);if(!i.socketReady){i.connect();i.queue.push(function(){i.socket.send(e)})}else{i.socket.send(e)}}if(d&&typeof d==="function"){a(document).on("cosm."+c,d)}};i.unsubscribe=function(a){var c='{"headers":{"X-ApiKey":"'+b+'"}, "method":"unsubscribe", "resource":"'+a+'"}';if(i.socket){i.socket.send(c)}};a.ajaxSetup({cache:false});d={endpoint:c,setKey:function(a){b=a},request:function(a){h(a)},subscribe:function(a,b){i.subscribe(a,b)},unsubscribe:function(a){i.unsubscribe(a)},live:function(b,d){var e=function(c,e){var f=c.current_value?c:e;if(f.current_value){a(b).each(function(){a(this).html(f.current_value).attr("data-cosm-resource",d)})}};h({url:c+d,always:e});i.subscribe(d,e)},stop:function(b){i.unsubscribe(a(b).first().attr("data-cosm-resource"))},feed:{get:function(a,b){h({url:c+"feeds/"+a+".json",always:b})},update:function(a,b,d){h({type:"put",url:c+"feeds/"+a+".json",data:b,always:d})},"new":function(a,b){h({type:"post",url:c+"feeds",data:a,always:b})},"delete":function(a,b){h({type:"delete",url:c+"feeds/"+a,always:b})},history:function(a,b,d){h({url:c+"feeds/"+a+".json",data:e(b),always:d})},list:function(a,b){h({url:c+"feeds",data:e(a),always:b})},subscribe:function(a,b){if(a){i.subscribe("/feeds/"+a,b)}},unsubscribe:function(a,b){if(a){i.unsubscribe("/feeds/"+a)}}},datastream:{get:function(a,b,d){h({url:c+"feeds/"+a+"/datastreams/"+b+".json",always:d})},update:function(a,b,d,e){h({type:"put",url:c+"feeds/"+a+"/datastreams/"+b+".json",data:d,always:e})},"new":function(a,b,d){h({type:"post",url:c+"feeds/"+a+"/datastreams",data:b,always:d})},"delete":function(a,b,d){h({type:"delete",url:c+"feeds/"+a+"/datastreams/"+b,always:d})},history:function(a,b,d,f){h({url:c+"feeds/"+a+"/datastreams/"+b+".json",data:e(d),always:f})},list:function(a,b){h({url:c+"feeds/"+a+".json",always:function(a){b.call(this,a.datastreams)}})},subscribe:function(a,b,c){if(a&&b){i.subscribe("/feeds/"+a+"/datastreams/"+b,c)}},unsubscribe:function(a,b,c){if(a&&b){i.unsubscribe("/feeds/"+a+"/datastreams/"+b)}},live:function(a,b,c){if(a&&b&&c){d.live(a,"/feeds/"+b+"/datastreams/"+c)}},stop:function(a){if(a){d.stop(a)}}},datapoint:{get:function(a,b,d,e){h({url:c+"feeds/"+a+"/datastreams/"+b+"/datapoints/"+d,always:e})},update:function(a,b,d,e,f){h({type:"put",url:c+"feeds/"+a+"/datastreams/"+b+"/datapoints/"+d,data:{value:e},always:f})},"new":function(a,b,d,e){h({type:"post",url:c+"feeds/"+a+"/datastreams/"+b+"/datapoints",data:d,always:e})},"delete":function(a,b,d,f){var g={type:"delete",always:f};if(typeof d==="object"){g.url=c+"feeds/"+a+"/datastreams/"+b+"/datapoints";g.data=e(d)}else{g.url=c+"feeds/"+a+"/datastreams/"+b+"/datapoints/"+d}h(g)},history:function(a,b,d,f){h({url:c+"feeds/"+a+"/datastreams/"+b+".json",data:e(d),always:function(a){f.call(this,a.datapoints)}})}}};return d}(jQuery);(function(a){"use strict";var b=function(a){if(typeof a==="object"){return"/feeds/"+a.feed+(a.datastream?"/datastreams/"+a.datastream:"")}else if(typeof a==="string"&&a!==""){return a}else{return""}},c={live:function(a){cosm.live(this,b(a));return this},get:function(c){var d=a(this);cosm.request({url:cosm.endpoint+b(c)+".json",always:function(b){d.each(function(){a(this).html(b.current_value)})}});return this}};a.fn.cosm=function(b){if(c[b]){return c[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return c.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.tooltip")}};a("[data-cosm]").each(function(){var b=a(this),c=b.data(),d=[];if(c.cosm.indexOf(",")!==-1){d=c.cosm.replace(/ /g,"").split(",");b.cosm(d[0],d.length===3?"/feeds/"+d[1]+"/datastreams/"+d[2]:d[1])}else if(c.cosmResource){b.cosm(c.cosm,c.cosmResource)}else if(c.cosmFeed&&c.cosmDatastream){b.cosm(c.cosm,"/feeds/"+c.cosmFeed+"/datastreams/"+c.cosmDatastream)}})})(jQuery)